<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>论文知识中枢</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Inter',sans-serif;background:#f7f7f7;color:#111827}
    .main-container{max-width:1200px;margin:0 auto}
    .search-container{background:#fff;border:1px solid #e5e7eb;border-radius:.5rem;padding:2rem}
    .info-card{background:#fff;border:1px solid #e5e7eb;border-radius:.5rem;padding:1.25rem}
    .paper-item{display:flex;gap:1.25rem;padding:1.25rem;background:#fff;border:1px solid #e5e7eb;border-radius:.5rem}
    .btn{padding:.5rem .875rem;border-radius:.375rem;font-weight:600}
    .btn-primary{background:#4f46e5;color:#fff}
    .btn-secondary{background:#6b7280;color:#fff}
    .loading{display:flex;align-items:center;justify-content:center;padding:2.5rem}
    .spin{width:24px;height:24px;border:3px solid #e5e7eb;border-top-color:#4f46e5;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .pdf-preview-container{width:100%;height:80vh;max-height:800px;background:#f8fafc;border-radius:0 0 .5rem .5rem;overflow:hidden}
    .pdf-toolbar{display:flex;justify-content:space-between;align-items:center;padding:.75rem 1rem;background:#fff;border-bottom:1px solid #e5e7eb}
    .pdf-canvas-container{flex:1;overflow:auto;display:flex;flex-direction:column;align-items:center;padding:1rem}
    .pdf-canvas{max-width:100%;height:auto;box-shadow:0 4px 6px -1px rgba(0,0,0,.1);border-radius:.25rem;margin-bottom:1rem}
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:1rem;background:rgba(0,0,0,.45);backdrop-filter:blur(3px);z-index:50}
    .modal-card{background:#fff;border-radius:.5rem;max-width:64rem;width:100%}
    .link-like{cursor:pointer;text-decoration:underline;text-decoration-color:transparent}
    .link-like:hover{color:#4f46e5;text-decoration-color:#4f46e5}
  </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">
  <div class="main-container">
    <header class="flex justify-between items-center mb-6 px-2">
      <div class="flex items-center gap-3">
        <svg class="w-8 h-8 text-indigo-600" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
        <h1 class="text-2xl font-bold text-gray-800">论文知识中枢</h1>
      </div>
      <div class="flex items-center gap-3">
        <button id="upload-button" class="btn btn-primary hidden">上传论文</button>
        <button id="batch-upload-button" class="btn btn-primary hidden">批量上传</button>
        <div id="login-trigger" class="font-semibold text-gray-600 hover:text-indigo-600 cursor-pointer">
          <span id="login-status-text">管理员登录</span>
        </div>
      </div>
    </header>

    <section class="search-container mb-8">
      <div class="relative">
        <input id="search-input" type="search" placeholder="搜索论文标题、作者或关键词..." class="w-full bg-gray-100 border border-gray-300 rounded-md py-3 pl-4 pr-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
      </div>
    </section>

    <section id="leaderboard-section" class="mb-8 grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="info-card"><h3 class="font-bold mb-2">最新上传</h3><ul id="lb-recent" class="text-sm text-gray-600 space-y-2"></ul></div>
      <div class="info-card"><h3 class="font-bold mb-2">热门预览</h3><ol id="lb-preview" class="text-sm text-gray-600 list-decimal list-inside space-y-2"></ol></div>
      <div class="info-card"><h3 class="font-bold mb-2">下载总榜</h3><ol id="lb-download" class="text-sm text-gray-600 list-decimal list-inside space-y-2"></ol></div>
    </section>

    <main id="paper-list" class="space-y-4"></main>
  </div>

  <div id="modals"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <script type="module">
    /************** Firebase （只用客户端读取 Firestore，避免依赖 /api/papers） **************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, getDocs, query, orderBy, limit, startAfter, startAt, endAt, doc, updateDoc, increment
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBo08_3_GqZeXpDI1jAsgS1XHZRK8PQQYY",
      authDomain: "pappershare.firebaseapp.com",
      projectId: "pappershare",
      storageBucket: "pappershare.firebasestorage.app",
      messagingSenderId: "390588624848",
      appId: "1:390588624848:web:ab43e1e7b8aa6ccd06d3d5",
    };

    let auth, db;
    let lastDoc = null;
    let isLoading = false;
    let allLoaded = false;
    let observer;
    const PAGE_SIZE = 10;

    /********************** 工具（OSS Key 规范化 + 预览/下载代理） ************************/
    function normalizeKey(input) {
      if (!input) return "";
      let key = String(input);
      try {
        if (/^https?:\/\//i.test(key)) {
          const u = new URL(key);
          key = u.pathname.replace(/^\/+/, "");
        }
      } catch {}
      try { key = decodeURIComponent(key); } catch {}
      return key.replace(/^\/+/, "");
    }
    function encodeKeyForQuery(k){return normalizeKey(k).split("/").map(encodeURIComponent).join("/");}
    function proxyUrl(name, disposition="inline"){ return `/api/pdf-proxy?name=${encodeKeyForQuery(name)}&disposition=${disposition}`; }

    function tsToDate(ts){
      if(!ts) return null;
      if (typeof ts.toDate === 'function') return ts.toDate();
      if (ts.seconds) return new Date(ts.seconds*1000);
      return null;
    }

    /********************************* UI 基础 *********************************/
    function el(html){const t=document.createElement('template');t.innerHTML=html.trim();return t.content.firstElementChild;}
    function showModal(inner, maxW='max-w-5xl'){
      const m = el(`<div class="modal"><div class="modal-card ${maxW}">${inner}</div></div>`);
      document.getElementById('modals').appendChild(m);
      m.addEventListener('click', (e)=>{ if(e.target===m) m.remove(); });
      return m;
    }

    /********************************* 列表渲染 *********************************/
    function renderPapers(docs){
      const container = document.getElementById('paper-list');
      const items = docs.map(d => {
        const data = d.data();
        // 尽量使用 uniquePath；否则从 fileUrl 提取
        const key = normalizeKey(data.uniquePath || data.fileUrl || data.fileName);
        const dt = tsToDate(data.uploadDate);
        return el(`
          <div class="paper-item" data-id="${d.id}">
            <div class="flex-1 min-w-0">
              <h2 class="text-lg font-bold text-gray-800 mb-1">
                <span class="link-like" data-action="summary" data-id="${d.id}" data-title="${data.title || ''}">${data.title || '未命名'}</span>
              </h2>
              <p class="text-sm text-gray-600 truncate">作者：${Array.isArray(data.authors)?data.authors.join(', '):(data.authors||'')}</p>
              <p class="text-sm text-gray-500 mt-1">年份：${dt?dt.getFullYear():'N/A'} ｜ 下载：${data.downloadCount||0} ｜ 预览：${data.previewCount||0}</p>
            </div>
            <div class="flex flex-col gap-2 w-28 items-stretch">
              <button class="btn btn-primary" data-action="preview" data-id="${d.id}" data-key="${key}">预览</button>
              <button class="btn btn-secondary" data-action="download" data-id="${d.id}" data-key="${key}">下载</button>
              ${auth.currentUser ? `<button class="btn bg-red-500 text-white" data-action="delete" data-id="${d.id}" data-key="${key}" data-title="${data.title||''}">删除</button>` : ``}
            </div>
          </div>
        `);
      });
      items.forEach(it => container.appendChild(it));
    }

    async function loadFirstPage(){
      isLoading = true;
      allLoaded = false;
      lastDoc = null;
      document.getElementById('paper-list').innerHTML = `<div class="loading"><div class="spin"></div></div>`;
      try{
        const q = query(collection(db,'papers'), orderBy('uploadDate','desc'), limit(PAGE_SIZE));
        const snap = await getDocs(q);
        document.getElementById('paper-list').innerHTML = '';
        if (snap.empty){ document.getElementById('paper-list').innerHTML = `<p class="text-center text-gray-500 py-8">这里还没有任何论文，快去上传吧！</p>`; allLoaded = true; return; }
        renderPapers(snap.docs);
        lastDoc = snap.docs[snap.docs.length-1];
        observeLoadMore();
      }catch(e){
        document.getElementById('paper-list').innerHTML = `<p class="text-center text-red-500 py-8">加载失败：${e.message}</p>`;
      }finally{ isLoading = false; }
    }

    async function loadNextPage(){
      if(isLoading || allLoaded || !lastDoc) return;
      isLoading = true;
      try{
        const q = query(collection(db,'papers'), orderBy('uploadDate','desc'), startAfter(lastDoc), limit(PAGE_SIZE));
        const snap = await getDocs(q);
        if (snap.empty){ allLoaded = true; return; }
        renderPapers(snap.docs);
        lastDoc = snap.docs[snap.docs.length-1];
        observeLoadMore();
      }catch(e){ console.error(e); } finally{ isLoading=false; }
    }

    function observeLoadMore(){
      if (observer) observer.disconnect();
      const last = document.querySelector('#paper-list .paper-item:last-child');
      if (!last) return;
      observer = new IntersectionObserver((entries)=>{
        if(entries[0].isIntersecting) loadNextPage();
      },{threshold:0.1});
      observer.observe(last);
    }

    async function searchByTitlePrefix(term){
      // Firestore 支持前缀搜索：orderBy('title'), startAt(term), endAt(term+'\uf8ff')
      document.getElementById('paper-list').innerHTML = `<div class="loading"><div class="spin"></div></div>`;
      try{
        const q = query(collection(db,'papers'), orderBy('title'), startAt(term), endAt(term+'\uf8ff'), limit(30));
        const snap = await getDocs(q);
        document.getElementById('paper-list').innerHTML = '';
        if (snap.empty){ document.getElementById('paper-list').innerHTML = `<p class="text-center text-gray-500 py-8">无匹配结果。</p>`; return; }
        renderPapers(snap.docs);
      }catch(e){
        document.getElementById('paper-list').innerHTML = `<p class="text-center text-red-500 py-8">搜索失败：${e.message}</p>`;
      }
    }

    /********************************* 排行榜 *********************************/
    async function updateLeaderboards(){
      const recentEl = document.getElementById('lb-recent');
      const previewEl = document.getElementById('lb-preview');
      const downloadEl = document.getElementById('lb-download');
      recentEl.innerHTML = previewEl.innerHTML = downloadEl.innerHTML = `<div class="spin"></div>`;

      try{
        const [recentSnap, previewSnap, downloadSnap] = await Promise.all([
          getDocs(query(collection(db,'papers'), orderBy('uploadDate','desc'), limit(10))),
          getDocs(query(collection(db,'papers'), orderBy('previewCount','desc'), limit(10))),
          getDocs(query(collection(db,'papers'), orderBy('downloadCount','desc'), limit(10))),
        ]);

        recentEl.innerHTML = recentSnap.empty ? `<li class="text-gray-400">暂无</li>` :
          recentSnap.docs.map(d => `<li class="truncate link-like" data-action="summary" data-id="${d.id}" data-title="${(d.data().title)||''}">${(d.data().title)||'未命名'}</li>`).join('');

        previewEl.innerHTML = previewSnap.empty ? `<li class="text-gray-400">暂无</li>` :
          previewSnap.docs.map(d => {
            const v = d.data(); return `<li class="truncate link-like" data-action="summary" data-id="${d.id}" data-title="${v.title||''}">${v.title||'未命名'}（${v.previewCount||0}）</li>`;
          }).join('');

        downloadEl.innerHTML = downloadSnap.empty ? `<li class="text-gray-400">暂无</li>` :
          downloadSnap.docs.map(d => {
            const v = d.data(); return `<li class="truncate link-like" data-action="summary" data-id="${d.id}" data-title="${v.title||''}">${v.title||'未命名'}（${v.downloadCount||0}）</li>`;
          }).join('');
      }catch(e){
        recentEl.innerHTML = previewEl.innerHTML = downloadEl.innerHTML = `<li class="text-red-500">加载失败</li>`;
        console.error(e);
      }
    }

    /********************************* PDF 预览 *********************************/
    function initPdfJs(){ if(window.pdfjsLib) window.pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js'; }

    async function openPreview(key, paperId){
      const modal = showModal(`
        <div class="rounded-t-md border-b p-4 flex items-center justify-between">
          <h3 class="text-lg font-bold">PDF 预览</h3>
          <button class="text-2xl text-gray-400 hover:text-gray-700" data-close>&times;</button>
        </div>
        <div class="pdf-preview-container flex flex-col">
          <div class="pdf-toolbar">
            <div class="text-sm text-gray-600" id="page-info"></div>
            <div class="flex items-center gap-2">
              <button id="zoom-out" class="px-3 py-1 border rounded">缩小</button>
              <span id="zoom-info" class="text-sm text-gray-600">100%</span>
              <button id="zoom-in" class="px-3 py-1 border rounded">放大</button>
            </div>
            <div>
              <a id="download-link" class="px-3 py-1 bg-indigo-600 text-white rounded">下载</a>
            </div>
          </div>
          <div id="pdf-canvas-container" class="pdf-canvas-container">
            <div class="loading"><div class="spin"></div></div>
          </div>
        </div>
      `);
      modal.querySelector('[data-close]').addEventListener('click', ()=>modal.remove());

      try{
        await updateDoc(doc(db,"papers",paperId), { previewCount: increment(1) });
      }catch(e){ console.warn("预览计数失败", e); }

      const url = proxyUrl(key, 'inline');
      modal.querySelector('#download-link').href = proxyUrl(key, 'attachment');

      try{
        const pdf = await window.pdfjsLib.getDocument({ url, withCredentials:true }).promise;
        const container = modal.querySelector('#pdf-canvas-container');
        const pageInfo = modal.querySelector('#page-info');
        const zoomInfo = modal.querySelector('#zoom-info');
        let scale = 1.0;
        pageInfo.textContent = `共 ${pdf.numPages} 页`;
        const renderAll = async ()=>{
          container.innerHTML = '';
          zoomInfo.textContent = `${Math.round(scale*100)}%`;
          for(let i=1;i<=pdf.numPages;i++){
            const page = await pdf.getPage(i);
            const vp = page.getViewport({ scale });
            const c = document.createElement('canvas');
            c.className = 'pdf-canvas'; c.width = vp.width; c.height = vp.height;
            container.appendChild(c);
            await page.render({ canvasContext:c.getContext('2d'), viewport:vp }).promise;
          }
        };
        await renderAll();
        modal.querySelector('#zoom-in').addEventListener('click', ()=>{ scale=Math.min(3,scale+.25); renderAll(); });
        modal.querySelector('#zoom-out').addEventListener('click', ()=>{ scale=Math.max(.25,scale-.25); renderAll(); });
      }catch(e){
        modal.querySelector('#pdf-canvas-container').innerHTML = `<div class="p-8 text-center text-red-500">预览失败：${e.message}</div>`;
      }
    }

    /********************************* AI 总结 *********************************/
    async function openSummary(id, title){
      const m = showModal(`
        <div class="rounded-t-md border-b p-4 flex items-center justify-between">
          <h3 class="text-lg font-bold">AI 总结：${title||''}</h3>
          <button class="text-2xl text-gray-400 hover:text-gray-700" data-close>&times;</button>
        </div>
        <div class="p-6" id="summary-content"><div class="loading"><div class="spin"></div></div></div>
      `,'max-w-3xl');
      m.querySelector('[data-close]').addEventListener('click', ()=>m.remove());
      try{
        const r = await fetch(`/api/get-summary?id=${encodeURIComponent(id)}`);
        const data = await r.json();
        const text = (data.summary||'').replace(/\n/g,'<br>');
        m.querySelector('#summary-content').innerHTML = text || '<p class="text-gray-500">暂无摘要</p>';
      }catch(e){
        m.querySelector('#summary-content').innerHTML = `<p class="text-red-500">加载失败：${e.message}</p>`;
      }
    }

    /********************************* 登录/上传（保留原有接口） *********************************/
    function openLogin(){
      const m = showModal(`
        <div class="p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold">管理员登录</h3>
            <button class="text-2xl text-gray-400 hover:text-gray-700" data-close>&times;</button>
          </div>
          <form id="login-form" class="space-y-3">
            <input name="email" type="email" required placeholder="邮箱" class="w-full bg-gray-100 border rounded px-3 py-2">
            <input name="password" type="password" required placeholder="密码" class="w-full bg-gray-100 border rounded px-3 py-2">
            <p id="login-error" class="text-sm text-red-500"></p>
            <button class="btn btn-primary w-full" type="submit">登录</button>
          </form>
        </div>
      `,'max-w-md');
      m.querySelector('[data-close]').addEventListener('click', ()=>m.remove());
      m.querySelector('#login-form').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const email = e.target.email.value.trim();
        const password = e.target.password.value.trim();
        const btn = e.target.querySelector('button[type="submit"]');
        btn.disabled = true; btn.textContent = '登录中...';
        try{
          await signInWithEmailAndPassword(auth,email,password);
          m.remove();
        }catch(e){ m.querySelector('#login-error').textContent = '邮箱或密码错误'; btn.disabled=false; btn.textContent='登录'; }
      });
    }

    /********************************* 事件绑定 *********************************/
    function bindGlobalEvents(){
      document.body.addEventListener('click', async (e)=>{
        const a = e.target.closest('[data-action]');
        if (!a) {
          if (e.target.closest('#login-trigger')){
            if (auth.currentUser) await signOut(auth); else openLogin();
          }
          return;
        }
        const action = a.dataset.action;
        if (action === 'preview'){
          await openPreview(a.dataset.key, a.dataset.id);
        }else if (action === 'download'){
          try{ await updateDoc(doc(db,"papers",a.dataset.id), { downloadCount: increment(1) }); }catch{}
          window.open(proxyUrl(a.dataset.key,'attachment'), '_blank');
        }else if (action === 'summary'){
          await openSummary(a.dataset.id, a.dataset.title);
        }else if (action === 'delete'){
          if(!confirm(`确定要删除「${a.dataset.title||''}」吗？`)) return;
          try{
            const token = await auth.currentUser.getIdToken();
            const resp = await fetch('/api/delete-paper', {
              method:'DELETE',
              headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},
              body: JSON.stringify({ id: a.dataset.id, fileName: a.dataset.key })
            });
            if(!resp.ok){ const err = await resp.json().catch(()=>({error:'删除失败'})); throw new Error(err.error||'删除失败'); }
            document.querySelector(`.paper-item[data-id="${a.dataset.id}"]`)?.remove();
          }catch(e){ alert(e.message); }
        }
      });

      // 搜索（前缀）
      const debounce = (fn,delay)=>{ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),delay); }; };
      const onSearch = debounce(async (val)=>{
        const term = val.trim();
        document.getElementById('leaderboard-section').style.display = term ? 'none' : 'grid';
        if (!term){ await loadFirstPage(); return; }
        await searchByTitlePrefix(term);
      }, 400);
      document.getElementById('search-input').addEventListener('input', (e)=>onSearch(e.target.value));
    }

    /********************************* 启动 *********************************/
    (async function boot(){
      try{
        initializeApp(firebaseConfig);
        auth = getAuth();
        db = getFirestore();
        initPdfJs();
        bindGlobalEvents();

        onAuthStateChanged(auth, user=>{
          const loginText = document.getElementById('login-status-text');
          const upBtn = document.getElementById('upload-button');
          const batchBtn = document.getElementById('batch-upload-button');
          if (user){
            loginText.textContent = `登出（${user.email.split('@')[0]}）`;
            upBtn.classList.remove('hidden'); batchBtn.classList.remove('hidden');
          }else{
            loginText.textContent = '管理员登录';
            upBtn.classList.add('hidden'); batchBtn.classList.add('hidden');
          }
          loadFirstPage();
          updateLeaderboards();
        });

      }catch(e){
        document.getElementById('paper-list').innerHTML = `<p class="text-center text-red-500 py-8">初始化失败：${e.message}</p>`;
      }
    })();
  </script>
</body>
</html>
